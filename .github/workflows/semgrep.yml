# ==============================================================================
# ðŸ›ï¸ AOXCDAO INSTITUTIONAL SECURITY FRAMEWORK
# ðŸ›¡ï¸ SYSTEM: Semgrep Static Application Security Testing (SAST)
# ðŸŽ¯ TARGET: Solidity 0.8.33 & OpenZeppelin 5.5.x Ecosystem
# ðŸŽ“ LEVEL: Pro Ultimate Academic / Enterprise Grade
# ðŸ”„ VERSION: 2.1.0 (Production Ready)
# ==============================================================================

name: Semgrep Institutional Analysis

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '40 10 * * 2' # Weekly deep-audit strategy
  workflow_dispatch:      # Allows manual execution for emergency audits

permissions:
  contents: read          # Access to institutional source code
  security-events: write  # Integration with GitHub Security Dashboard
  actions: read           # Workflow status monitoring

jobs:
  semgrep-security-audit:
    name: "Academic Security Audit"
    runs-on: ubuntu-latest
    timeout-minutes: 30   # Prevents hanging processes in large-scale audits

    steps:
      # Step 1: Institutional Checkout with Full Depth
      - name: ðŸ“¥ Repository Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Advanced Semgrep Logic Implementation
      # We use the official action for better signal handling and SARIF generation.
      - name: ðŸ” Professional Vulnerability Scanning
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/solidity
            p/owasp-top-10
            p/default
            p/security-audit
          generateSarif: "1"
          # auditOn: Ensures findings are uploaded to Security Tab even if high-risk issues exist.
          auditOn: push
          # Specific versioning to align with academic precision
          imageTag: latest 

      # Step 3: Formal SARIF Ingestion
      # This step visualizes institutional threats directly on the codebase.
      - name: ðŸ“¤ Upload Institutional Security Report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        if: always() # Guarantee report delivery regardless of scan result

# ==============================================================================
# ðŸ“œ ARCHITECTURAL SPECIFICATIONS & LOGIC:
# 1. FAIL-SAFE MECHANISM: Shifting from manual 'docker run' to 'semgrep-action' 
#    eliminates volume mapping issues and handles Exit Code 7 gracefully.
# 2. ENHANCED CONFIG: Added 'p/security-audit' for deeper institutional logic.
# 3. PERMISSION SCOPE: Strictly adheres to the principle of least privilege.
# 4. SOLC ALIGNMENT: Designed for 0.8.33 EVM-compatible syntax validation.
# ==============================================================================
