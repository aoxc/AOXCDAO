# ==============================================================================
# üèõÔ∏è AOXCDAO INSTITUTIONAL SECURITY FRAMEWORK
# üõ°Ô∏è SYSTEM: Semgrep Static Application Security Testing (SAST)
# üéØ TARGET: Solidity 0.8.33 & OpenZeppelin 5.5.x Ecosystem
# üéì LEVEL: Pro Ultimate Academic / Enterprise Grade
# ==============================================================================

name: Semgrep Institutional Analysis

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  # Scheduled Scan: Runs every Tuesday at 10:40 UTC to ensure persistent integrity.
  schedule:
    - cron: '40 10 * * 2'

permissions:
  contents: read           # Permission to scan the source code
  security-events: write   # Permission to report findings to GitHub Security Tab
  actions: read            # Permission to monitor workflow execution status

jobs:
  semgrep-security-audit:
    name: "Academic Security Audit"
    runs-on: ubuntu-latest
    
    # Utilizing an isolated Docker container for environment consistency
    container:
      image: returntocorp/semgrep

    steps:
      # Step 1: Securely fetch the repository content
      - name: üì• Repository Checkout
        uses: actions/checkout@v4

      # Step 2: Comprehensive Vulnerability Scanning
      # We operate in 'scan' mode with multiple high-level configurations.
      # Note: We do not use --strict to prevent "Exit Code 7" from breaking the report upload.
      - name: üîç Professional Vulnerability Scanning
        run: |
          semgrep scan \
            --config="p/solidity" \
            --config="p/owasp-top-10" \
            --config="p/default" \
            --sarif --output=semgrep-results.sarif \
            --metrics=off
        # Logic: 
        # 'p/solidity' targets Reentrancy, Overflow, and Logic flaws.
        # 'p/owasp-top-10' targets the industry-standard top 10 security risks.

      # Step 3: Institutional Integration with GitHub Advanced Security
      # This step populates the 'Security' tab with academic-grade insights.
      - name: üì§ Upload Institutional Security Report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
        # 'if: always()' ensures the report is uploaded even if vulnerabilities are found.
        if: always()

# ==============================================================================
# üìú TECHNICAL SPECIFICATIONS & LOGIC
# 1. COMPILER COMPLIANCE: Validates syntax for Solidity 0.8.33.
# 2. LIBRARY INTEGRITY: Monitors OpenZeppelin 5.5.x implementation patterns.
# 3. SARIF STANDARDS: Outputs results in Static Analysis Results Interchange Format.
# 4. ZERO-MOCK POLICY: Analysis assumes real-world mainnet state logic.
# ==============================================================================
