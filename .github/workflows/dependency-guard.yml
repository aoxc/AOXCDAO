# ==============================================================================
# ğŸ›ï¸ AOXCDAO INSTITUTIONAL DEPENDENCY & BUILD GUARD
# ğŸ›¡ï¸ ARCHITECTURE: Least Privilege / Deterministic Build / OZ v5.5 Enforcement
# ğŸ“ LEVEL: Pro Ultimate Academic / Enterprise Grade
# ==============================================================================

name: "ğŸ›¡ï¸ AOXCDAO Dependency & Build Guard"

on:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop ]

# --- [GLOBAL SECURITY HARDENING] ---
# TÃ¼m workflow iÃ§in yetkileri varsayÄ±lan olarak sÄ±fÄ±rlÄ±yoruz.
# Sadece repoyu okuma izni veriyoruz (CWE-275 Fix).
permissions:
  contents: read

jobs:
  deterministic-build:
    name: "Deterministic Build & Integrity"
    runs-on: ubuntu-latest
    
    # Ä°ÅŸ seviyesinde de yetkiyi kÄ±sÄ±tlayarak gÃ¼venliÄŸi Ã§ift katmanlÄ± yapÄ±yoruz.
    permissions:
      contents: read
      pull-requests: read

    steps:
      # -------------------------------------------------
      # CHECKOUT (FULL HISTORY + SUBMODULES)
      # -------------------------------------------------
      - name: ğŸ“¥ Repository Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # -------------------------------------------------
      # STABLE FOUNDRY INSTALLATION
      # -------------------------------------------------
      - name: ğŸ› ï¸ Install Foundry (Institutional Latest)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: ğŸ” Verify Forge Environment
        run: |
          forge --version
          solc --version

      # -------------------------------------------------
      # LOCKFILE & SUBMODULE INTEGRITY
      # -------------------------------------------------
      - name: ğŸ” Lockfile & Submodule Validation
        run: |
          forge install --check
          git diff --exit-code foundry.lock || (echo "âŒ Dependency drift in foundry.lock" && exit 1)
          
          git submodule sync --recursive
          git submodule update --init --recursive
          if git submodule status | grep -q "^+"; then
            echo "âŒ Submodule pointer mismatch detected."
            exit 1
          fi

      # -------------------------------------------------
      # OPENZEPPELIN 5.5.x ENFORCEMENT
      # -------------------------------------------------
      - name: ğŸ›¡ï¸ Enforce OpenZeppelin v5.5.x Compliance
        run: |
          # Core Contracts Check
          if [ -d "lib/openzeppelin-contracts" ]; then
            cd lib/openzeppelin-contracts
            git describe --tags --always | grep -q "v5.5" || (echo "âŒ OpenZeppelin core must be v5.5.x" && exit 1)
            cd ../..
          fi
          
          # Upgradeable Contracts Check
          if [ -d "lib/openzeppelin-contracts-upgradeable" ]; then
            cd lib/openzeppelin-contracts-upgradeable
            git describe --tags --always | grep -q "v5.5" || (echo "âŒ OpenZeppelin upgradeable must be v5.5.x" && exit 1)
            cd ../..
          fi

      # -------------------------------------------------
      # ARCHITECTURAL INTEGRITY
      # -------------------------------------------------
      - name: ğŸ“ Remappings & Format Integrity
        run: |
          # Remappings.txt kontrolÃ¼ (eÄŸer dosya mevcutsa)
          if [ -f "remappings.txt" ]; then
            git diff --exit-code remappings.txt || (echo "âŒ remappings.txt was modified" && exit 1)
          fi
          forge fmt --check

      # -------------------------------------------------
      # DETERMINISTIC COMPILATION (Solidity 0.8.33)
      # -------------------------------------------------
      - name: ğŸ—ï¸ Clean Academic Build
        run: |
          forge clean
          forge build --sizes

      # -------------------------------------------------
      # FULL INSTITUTIONAL TEST SUITE
      # -------------------------------------------------
      - name: ğŸ§ª Execute Test Suite
        run: forge test -vvv
