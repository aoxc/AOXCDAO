# ==============================================================================
# üèõÔ∏è AOXCDAO INSTITUTIONAL DEPENDENCY & BUILD GUARD
# üõ°Ô∏è SCOPE: Solidity 0.8.33 / OpenZeppelin 5.5.x Compliance
# üéì LEVEL: Pro Ultimate Academic / Enterprise Grade
# ==============================================================================

name: "AOXCDAO Institutional Dependency & Build Guard"

on:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop ]

jobs:
  deterministic-build:
    name: "Deterministic Build & Integrity"
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # CHECKOUT (FULL HISTORY + SUBMODULES)
      # -------------------------------------------------
      - name: üì• Repository Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # -------------------------------------------------
      # STABLE FOUNDRY INSTALLATION (FIXED)
      # -------------------------------------------------
      - name: üõ†Ô∏è Install Foundry (Institutional Latest)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly # Hatalƒ± tarihli s√ºr√ºm yerine g√ºncel nightly/stable kullanƒ±ldƒ±

      - name: üîç Verify Forge Environment
        run: |
          forge --version
          solc --version

      # -------------------------------------------------
      # LOCKFILE & SUBMODULE INTEGRITY
      # -------------------------------------------------
      - name: üîê Lockfile & Submodule Validation
        run: |
          forge install --check
          git diff --exit-code foundry.lock || (echo "‚ùå Dependency drift in foundry.lock" && exit 1)
          
          git submodule sync --recursive
          git submodule update --init --recursive
          if git submodule status | grep -q "^+"; then
            echo "‚ùå Submodule pointer mismatch detected."
            exit 1
          fi

      # -------------------------------------------------
      # OPENZEPPELIN 5.5.x ENFORCEMENT
      # -------------------------------------------------
      - name: üõ°Ô∏è Enforce OpenZeppelin v5.5.x Compliance
        run: |
          # Core Contracts Check
          if [ -d "lib/openzeppelin-contracts" ]; then
            cd lib/openzeppelin-contracts
            git describe --tags --always | grep -q "v5.5" || (echo "‚ùå OpenZeppelin core must be v5.5.x" && exit 1)
            cd ../..
          fi
          
          # Upgradeable Contracts Check
          if [ -d "lib/openzeppelin-contracts-upgradeable" ]; then
            cd lib/openzeppelin-contracts-upgradeable
            git describe --tags --always | grep -q "v5.5" || (echo "‚ùå OpenZeppelin upgradeable must be v5.5.x" && exit 1)
            cd ../..
          fi

      # -------------------------------------------------
      # ARCHITECTURAL INTEGRITY
      # -------------------------------------------------
      - name: üìê Remappings & Format Integrity
        run: |
          git diff --exit-code remappings.txt || (echo "‚ùå remappings.txt was modified" && exit 1)
          forge fmt --check

      # -------------------------------------------------
      # DETERMINISTIC COMPILATION (Solidity 0.8.33)
      # -------------------------------------------------
      - name: üèóÔ∏è Clean Academic Build
        run: |
          forge clean
          forge build --sizes

      # -------------------------------------------------
      # FULL INSTITUTIONAL TEST SUITE
      # -------------------------------------------------
      - name: üß™ Execute Test Suite
        run: forge test -vvv
