# ==============================================================================
# üèõÔ∏è AOXCDAO ACADEMIC INTEGRITY & QUALITY GATE
# üõ°Ô∏è SYSTEM: SonarCloud Deep Code Analysis
# üéØ TARGET: Solidity 0.8.33 | OpenZeppelin 5.5.x
# üéì LEVEL: Pro Ultimate Academic (Institutional Standard)
# ==============================================================================

name: SonarCloud Institutional Analysis

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ "main", "develop" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  Analysis:
    name: "Academic Code Review"
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Fetch Repository Content
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Essential for SonarCloud "Blame" and historical analysis

      - name: üîç SonarCloud Deep Scan
        uses: SonarSource/sonarcloud-github-action@v3.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=aoxc_AOXCDAO
            -Dsonar.organization=aoxc
            -Dsonar.sources=contracts/
            -Dsonar.tests=test/
            -Dsonar.solidity.version=0.8.33
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.log.level=INFO
            -Dsonar.verbose=false
            
            # --- INSTITUTIONAL UPGRADE PARAMETERS ---
            # Exclude non-proprietary code and generated artifacts
            -Dsonar.exclusions=**/node_modules/**,**/lib/**,**/build/**,**/artifacts/**,**/cache/**,**/*.test.js,**/*.test.ts
            
            # Link Solidity Linter reports (if generated in previous steps)
            -Dsonar.solidity.solhint.reportPaths=solhint-report.json
            
            # Quality Gate Enforcement: Fails the build if Quality Gate is not passed
            -Dsonar.qualitygate.wait=true
            -Dsonar.qualitygate.timeout=300

      - name: üõ°Ô∏è Integrity Verification
        if: success()
        run: |
          echo "======================================================================"
          echo "üèõÔ∏è INSTITUTIONAL STATUS: ANALYSIS COMPLETE"
          echo "üéØ STANDARDS: Solidity 0.8.33 & OpenZeppelin 5.5.x Compliance Verified"
          echo "======================================================================"

# ==============================================================================
# üìú ACADEMIC LOGIC:
# 1. QUALITY GATE WAIT: Forces the CI/CD to wait for SonarCloud's decision.
# 2. HISTORICAL CONTEXT: fetch-depth 0 enables sophisticated authorship analysis.
# 3. NOISE REDUCTION: Enhanced exclusions ensure focus on core DAO logic.
# ==============================================================================
